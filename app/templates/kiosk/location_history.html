{% extends "base.html" %}

{% block title %}Historial de Ubicaciones - {{ kiosk.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.7.0/css/buttons.bootstrap5.min.css">
<style>
    #map { 
        height: 400px; 
        width: 100%; 
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .filters {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2>Historial de Ubicaciones - {{ kiosk.name }}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('kiosk.list_kiosks') }}">Kiosks</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('kiosk.view_kiosk', kiosk_id=kiosk.id) }}">{{ kiosk.name }}</a></li>
                    <li class="breadcrumb-item active">Historial de Ubicaciones</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body filters">
                    <form id="filter-form" class="row g-3">
                        <div class="col-md-3">
                            <label for="date-from" class="form-label">Desde</label>
                            <input type="datetime-local" class="form-control" id="date-from" name="date_from">
                        </div>
                        <div class="col-md-3">
                            <label for="date-to" class="form-label">Hasta</label>
                            <input type="datetime-local" class="form-control" id="date-to" name="date_to">
                        </div>
                        <div class="col-md-3">
                            <label for="location-type" class="form-label">Tipo de Ubicación</label>
                            <select class="form-select" id="location-type" name="location_type">
                                <option value="">Todos</option>
                                <option value="assigned">Asignada</option>
                                <option value="reported">Reportada</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-filter"></i> Filtrar
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetFilters()">
                                <i class="fas fa-undo"></i> Resetear
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Mapa y Tabla -->
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Registros de Ubicación</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="history-table" class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Ubicación Anterior</th>
                                    <th>Nueva Ubicación</th>
                                    <th>Precisión</th>
                                    <th>Razón del Cambio</th>
                                    <th>Usuario</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Los datos se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Visualización en Mapa</h5>
                </div>
                <div class="card-body">
                    <div id="map"></div>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-primary" onclick="centerMap()">
                            <i class="fas fa-crosshairs"></i> Centrar Mapa
                        </button>
                        <button class="btn btn-sm btn-info" onclick="showAllPoints()">
                            <i class="fas fa-eye"></i> Mostrar Todos los Puntos
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.print.min.js"></script>

<script>
let map = null;
let markers = [];
let table = null;

function initMap() {
    map = L.map('map').setView([{{ kiosk.latitude }}, {{ kiosk.longitude }}], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
}

function loadLocationHistory(filters = {}) {
    const url = new URL(`/kiosk/api/kiosk/{{ kiosk.id }}/location_history`, window.location.origin);
    Object.keys(filters).forEach(key => {
        if (filters[key]) url.searchParams.append(key, filters[key]);
    });

    if (!table) {
        table = $('#history-table').DataTable({
            ajax: {
                url: url,
                dataSrc: ''
            },
            order: [[0, 'desc']],
            columns: [
                {
                    data: 'timestamp',
                    render: function(data) {
                        return new Date(data).toLocaleString();
                    }
                },
                {
                    data: 'location_type',
                    render: function(data) {
                        const badge = data === 'assigned' ? 'primary' : 'info';
                        const text = data === 'assigned' ? 'Asignada' : 'Reportada';
                        return `<span class="badge bg-${badge}">${text}</span>`;
                    }
                },
                {
                    data: null,
                    render: function(data) {
                        if (data.previous_latitude && data.previous_longitude) {
                            return `${data.previous_latitude.toFixed(6)}, ${data.previous_longitude.toFixed(6)}`;
                        }
                        return 'N/A';
                    }
                },
                {
                    data: null,
                    render: function(data) {
                        return `${data.latitude.toFixed(6)}, ${data.longitude.toFixed(6)}`;
                    }
                },
                {
                    data: 'accuracy',
                    render: function(data) {
                        return data ? `${data.toFixed(2)}m` : 'N/A';
                    }
                },
                { data: 'change_reason' },
                { 
                    data: 'created_by',
                    render: function(data) {
                        return data || 'Sistema';
                    }
                }
            ],
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'csv',
                    text: '<i class="fas fa-file-csv"></i> CSV',
                    className: 'btn btn-sm btn-secondary'
                },
                {
                    extend: 'excel',
                    text: '<i class="fas fa-file-excel"></i> Excel',
                    className: 'btn btn-sm btn-secondary'
                }
            ]
        });
    } else {
        table.ajax.url(url).load();
    }
}

function updateMap(data) {
    // Limpiar marcadores existentes
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];

    // Agregar nuevos marcadores
    data.forEach(record => {
        const marker = L.marker([record.latitude, record.longitude], {
            title: `${new Date(record.timestamp).toLocaleString()} - ${record.location_type}`
        });
        
        marker.bindPopup(`
            <strong>Fecha:</strong> ${new Date(record.timestamp).toLocaleString()}<br>
            <strong>Tipo:</strong> ${record.location_type === 'assigned' ? 'Asignada' : 'Reportada'}<br>
            <strong>Precisión:</strong> ${record.accuracy ? record.accuracy.toFixed(2) + 'm' : 'N/A'}<br>
            ${record.change_reason ? '<strong>Razón:</strong> ' + record.change_reason : ''}
        `);
        
        markers.push(marker);
        marker.addTo(map);
    });
}

function centerMap() {
    if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds());
    }
}

function showAllPoints() {
    if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds());
    }
}

function resetFilters() {
    document.getElementById('filter-form').reset();
    loadLocationHistory();
}

document.addEventListener('DOMContentLoaded', function() {
    initMap();
    loadLocationHistory();

    document.getElementById('filter-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const filters = {
            date_from: document.getElementById('date-from').value,
            date_to: document.getElementById('date-to').value,
            location_type: document.getElementById('location-type').value
        };
        loadLocationHistory(filters);
    });
});
</script>
{% endblock %} 