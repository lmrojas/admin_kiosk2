<!-- EL CÓDIGO DE ESTE ARCHIVO PUEDE MODIFICARSE UNICAMENTE Y 
     SOLAMENTE SIGUIENDO LO ESTABLECIDO EN 'cura.md' Y 'project_custom_structure.txt' -->
{% extends "base.html" %}

{% block title %}Detalles de Kiosk - {{ kiosk.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    #map { height: 400px; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Información General -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Información General</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Nombre:</strong> {{ kiosk.name }}</p>
                            <p><strong>Ubicación:</strong> {{ kiosk.location or 'N/A' }}</p>
                            <p><strong>UUID:</strong> {{ kiosk.uuid }}</p>
                            <p><strong>Estado:</strong> 
                                <span class="badge bg-{{ 'success' if kiosk.status == 'active' else 'danger' }}">
                                    {{ kiosk.status }}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Creado:</strong> {{ kiosk.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                            <p><strong>Última Actualización:</strong> {{ kiosk.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                            <p><strong>Última Conexión:</strong> 
                                {{ kiosk.last_online.strftime('%Y-%m-%d %H:%M:%S') if kiosk.last_online else 'Nunca' }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Estado de Salud</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-{{ 'success' if kiosk.health_score > 70 else 'warning' if kiosk.health_score > 30 else 'danger' }}" 
                                 role="progressbar" 
                                 style="width: {{ kiosk.health_score }}%">
                                {{ "%.1f"|format(kiosk.health_score) }}%
                            </div>
                        </div>
                    </div>
                    <p class="text-center">
                        <strong>Probabilidad de Anomalía:</strong><br>
                        {{ "%.2f"|format(kiosk.anomaly_probability * 100) }}%
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Geolocalización -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Ubicación del Kiosk</h5>
                    {% if kiosk.latitude and kiosk.longitude %}
                    <button class="btn btn-sm btn-primary" onclick="centerMap()">
                        Centrar Mapa
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if kiosk.latitude and kiosk.longitude %}
                    <div class="row">
                        <div class="col-md-4">
                            <p><strong>Latitud:</strong> {{ "%.6f"|format(kiosk.latitude) }}</p>
                            <p><strong>Longitud:</strong> {{ "%.6f"|format(kiosk.longitude) }}</p>
                            {% if kiosk.altitude %}
                            <p><strong>Altitud:</strong> {{ "%.2f"|format(kiosk.altitude) }} m</p>
                            {% endif %}
                            {% if kiosk.location_accuracy %}
                            <p><strong>Precisión:</strong> {{ "%.2f"|format(kiosk.location_accuracy) }} m</p>
                            {% endif %}
                            <p><strong>Última Actualización:</strong><br>
                               {{ kiosk.location_updated_at.strftime('%Y-%m-%d %H:%M:%S') if kiosk.location_updated_at else 'N/A' }}
                            </p>
                        </div>
                        <div class="col-md-8">
                            <div id="map"></div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        No hay información de geolocalización disponible para este kiosk.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Información de Hardware -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Hardware</h5>
                </div>
                <div class="card-body">
                    <p><strong>CPU:</strong> {{ kiosk.cpu_model or 'N/A' }}</p>
                    <p><strong>RAM Total:</strong> {{ "%.2f"|format(kiosk.ram_total) if kiosk.ram_total else 'N/A' }} GB</p>
                    <p><strong>Almacenamiento Total:</strong> {{ "%.2f"|format(kiosk.storage_total) if kiosk.storage_total else 'N/A' }} GB</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Red</h5>
                </div>
                <div class="card-body">
                    <p><strong>Dirección IP:</strong> {{ kiosk.ip_address or 'N/A' }}</p>
                    <p><strong>Dirección MAC:</strong> {{ kiosk.mac_address or 'N/A' }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Datos de Sensores Recientes -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Datos de Sensores (Últimas 24 horas)</h5>
            <button class="btn btn-sm btn-primary" onclick="updateChart()">
                Actualizar
            </button>
        </div>
        <div class="card-body">
            {% if recent_data %}
            <div class="chart-container" style="position: relative; height:400px;">
                <canvas id="sensorChart"></canvas>
            </div>
            {% else %}
            <div class="alert alert-info">
                No hay datos de sensores registrados en las últimas 24 horas.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Botones de Acción -->
    <div class="mt-4">
        <a href="{{ url_for('kiosk.update_kiosk', kiosk_id=kiosk.id) }}" class="btn btn-warning">
            Editar Kiosk
        </a>
        <a href="{{ url_for('kiosk.list_kiosks') }}" class="btn btn-secondary">
            Volver a la Lista
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    // Inicialización del mapa
    {% if kiosk.latitude and kiosk.longitude %}
    const map = L.map('map').setView([{{ kiosk.latitude }}, {{ kiosk.longitude }}], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const marker = L.marker([{{ kiosk.latitude }}, {{ kiosk.longitude }}])
        .addTo(map)
        .bindPopup("{{ kiosk.name }}");

    function centerMap() {
        map.setView([{{ kiosk.latitude }}, {{ kiosk.longitude }}], 13);
    }

    // Buscar kiosks cercanos
    fetch(`/kiosk/api/nearby?lat={{ kiosk.latitude }}&lon={{ kiosk.longitude }}&radius=5`)
        .then(response => response.json())
        .then(data => {
            data.forEach(kiosk => {
                if (kiosk.id !== {{ kiosk.id }}) {
                    L.marker([kiosk.latitude, kiosk.longitude])
                        .addTo(map)
                        .bindPopup(kiosk.name);
                }
            });
        });
    {% endif %}

    // Datos para el gráfico
    const sensorData = {
        timestamps: [{% for data in recent_data %}"{{ data.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}"{{ "," if not loop.last }}{% endfor %}],
        cpu: [{% for data in recent_data %}{{ data.cpu_usage }}{{ "," if not loop.last }}{% endfor %}],
        memory: [{% for data in recent_data %}{{ data.memory_usage }}{{ "," if not loop.last }}{% endfor %}],
        network: [{% for data in recent_data %}{{ data.network_latency or 0 }}{{ "," if not loop.last }}{% endfor %}]
    };

    // Configuración del gráfico
    const ctx = document.getElementById('sensorChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: sensorData.timestamps,
            datasets: [{
                label: 'CPU (%)',
                data: sensorData.cpu,
                borderColor: 'rgb(255, 99, 132)',
                tension: 0.1
            }, {
                label: 'Memoria (%)',
                data: sensorData.memory,
                borderColor: 'rgb(54, 162, 235)',
                tension: 0.1
            }, {
                label: 'Latencia (ms)',
                data: sensorData.network,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Función para actualizar el gráfico
    function updateChart() {
        fetch(`/kiosk/api/sensor-data/${kiosk.id}`)
            .then(response => response.json())
            .then(data => {
                chart.data.labels = data.timestamps;
                chart.data.datasets[0].data = data.cpu;
                chart.data.datasets[1].data = data.memory;
                chart.data.datasets[2].data = data.network;
                chart.update();
            });
    }

    // Actualizar cada 30 segundos
    setInterval(updateChart, 30000);
</script>
{% endblock %} 