<!-- EL CÓDIGO DE ESTE ARCHIVO PUEDE MODIFICARSE UNICAMENTE Y 
     SOLAMENTE SIGUIENDO LO ESTABLECIDO EN 'cura.md' Y 'project_custom_structure.txt' -->
{% extends "base.html" %}

{% block title %}Detalles de Kiosk - {{ kiosk.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    #map { 
        height: 400px; 
        width: 100%; 
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-height: 400px;
        display: block !important;
    }
    .legend {
        padding: 6px 8px;
        background: white;
        background: rgba(255,255,255,0.8);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
        line-height: 24px;
    }
    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Información General -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Información General</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Nombre:</strong> {{ kiosk.name }}</p>
                            <p><strong>Ubicación:</strong> {{ kiosk.location or 'N/A' }}</p>
                            <p><strong>UUID:</strong> {{ kiosk.uuid }}</p>
                            <p><strong>Estado:</strong> 
                                <span class="badge bg-{{ 'success' if kiosk.status == 'active' else 'danger' }}">
                                    {{ kiosk.status }}
                                </span>
                            </p>
                            <p><strong>Nombre del Local:</strong> {{ kiosk.store_name or 'No especificado' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Creado:</strong> {{ kiosk.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                            <p><strong>Última Actualización:</strong> {{ kiosk.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                            <p><strong>Última Conexión:</strong> 
                                {{ kiosk.last_online.strftime('%Y-%m-%d %H:%M:%S') if kiosk.last_online else 'Nunca' }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Estado de Salud</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-{{ 'success' if kiosk.health_score > 70 else 'warning' if kiosk.health_score > 30 else 'danger' }}" 
                                 role="progressbar" 
                                 style="width: {{ kiosk.health_score }}%">
                                {{ "%.1f"|format(kiosk.health_score) }}%
                            </div>
                        </div>
                    </div>
                    <p class="text-center">
                        <strong>Probabilidad de Anomalía:</strong><br>
                        {{ "%.2f"|format(kiosk.anomaly_probability * 100) }}%
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Geolocalización -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Ubicación del Kiosk</h5>
                </div>
                <div class="card-body">
                    {% if kiosk.latitude and kiosk.longitude %}
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Ubicación Asignada:</h6>
                            <p><strong>Latitud:</strong> {{ "%.6f"|format(kiosk.latitude) }}</p>
                            <p><strong>Longitud:</strong> {{ "%.6f"|format(kiosk.longitude) }}</p>
                            {% if kiosk.reported_latitude and kiosk.reported_longitude %}
                            <h6 class="mt-3">Ubicación Reportada:</h6>
                            <p><strong>Latitud:</strong> {{ "%.6f"|format(kiosk.reported_latitude) }}</p>
                            <p><strong>Longitud:</strong> {{ "%.6f"|format(kiosk.reported_longitude) }}</p>
                            {% endif %}
                            <button class="btn btn-primary btn-sm mt-2" onclick="centerMap()">
                                <i class="fas fa-crosshairs"></i> Centrar Mapa
                            </button>
                        </div>
                        <div class="col-md-8">
                            <div id="map" style="min-height: 400px;"></div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        No hay información de geolocalización disponible para este kiosk.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Historial de Ubicaciones -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Historial de Ubicaciones</h5>
                    <div>
                        <a href="{{ url_for('kiosk.location_history', kiosk_id=kiosk.id) }}" class="btn btn-sm btn-info me-2">
                            <i class="fas fa-history"></i> Ver Historial Completo
                        </a>
                        <button class="btn btn-sm btn-primary" onclick="refreshLocationHistory()">
                            <i class="fas fa-sync"></i> Actualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Ubicación Anterior</th>
                                    <th>Nueva Ubicación</th>
                                    <th>Precisión</th>
                                    <th>Razón del Cambio</th>
                                </tr>
                            </thead>
                            <tbody id="location-history-table">
                                <tr>
                                    <td colspan="6" class="text-center">
                                        Cargando historial...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Información de Hardware -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Hardware</h5>
                </div>
                <div class="card-body">
                    <p><strong>CPU:</strong> {{ kiosk.cpu_model or 'N/A' }}</p>
                    <p><strong>RAM Total:</strong> {{ "%.2f"|format(kiosk.ram_total) if kiosk.ram_total else 'N/A' }} GB</p>
                    <p><strong>Almacenamiento Total:</strong> {{ "%.2f"|format(kiosk.storage_total) if kiosk.storage_total else 'N/A' }} GB</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Red</h5>
                </div>
                <div class="card-body">
                    <p><strong>Dirección IP:</strong> {{ kiosk.ip_address or 'N/A' }}</p>
                    <p><strong>Dirección MAC:</strong> {{ kiosk.mac_address or 'N/A' }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Datos de Sensores Recientes -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Datos de Sensores (Últimas 24 horas)</h5>
            <button class="btn btn-sm btn-primary" onclick="updateChart()">
                Actualizar
            </button>
        </div>
        <div class="card-body">
            {% if recent_data %}
            <div class="chart-container" style="position: relative; height:400px;">
                <canvas id="sensorChart"></canvas>
            </div>
            {% else %}
            <div class="alert alert-info">
                No hay datos de sensores registrados en las últimas 24 horas.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Agregar contenedor de estado de conexión -->
    <div id="connection-status" class="mb-3"></div>

    <!-- Agregar contenedor de alertas -->
    <div id="alerts-container" class="mb-3"></div>

    <!-- Agregar contenedor de anomalías -->
    <div id="anomaly-container" class="mb-3"></div>

    <!-- Botones de Acción -->
    <div class="mt-4">
        <a href="{{ url_for('kiosk.update_kiosk', kiosk_id=kiosk.id) }}" class="btn btn-warning">
            Editar Kiosk
        </a>
        <a href="{{ url_for('kiosk.list_kiosks') }}" class="btn btn-secondary">
            Volver a la Lista
        </a>
        <form action="{{ url_for('kiosk.delete_kiosk', kiosk_uuid=kiosk.uuid) }}" method="post" class="d-inline ms-2" onsubmit="return confirm('¿Estás seguro de eliminar este kiosk?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger">
                <i class="fas fa-trash"></i> Eliminar
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
let kioskMap = null;
let sensorChart = null;
let socket = null;

{% if kiosk.latitude and kiosk.longitude %}
function initMap() {
    console.log('Coordenadas disponibles:', {{ kiosk.latitude }}, {{ kiosk.longitude }});
    
    // Inicializar el mapa
    kioskMap = L.map('map').setView([{{ kiosk.latitude }}, {{ kiosk.longitude }}], 13);
    
    // Agregar capa de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(kioskMap);

    // Agregar marcador para ubicación asignada
    const assignedMarker = L.marker([{{ kiosk.latitude }}, {{ kiosk.longitude }}], {
        title: 'Ubicación Asignada'
    }).addTo(kioskMap);
    assignedMarker.bindPopup('Ubicación Asignada');

    {% if kiosk.reported_latitude and kiosk.reported_longitude %}
    // Agregar marcador para ubicación reportada
    const reportedMarker = L.marker([{{ kiosk.reported_latitude }}, {{ kiosk.reported_longitude }}], {
        title: 'Ubicación Reportada',
        icon: L.divIcon({
            className: 'custom-div-icon',
            html: '<div style="background-color: #3498db;" class="marker-pin"></div>',
            iconSize: [30, 42],
            iconAnchor: [15, 42]
        })
    }).addTo(kioskMap);
    reportedMarker.bindPopup('Ubicación Reportada');

    // Dibujar línea entre los puntos
    const latlngs = [
        [{{ kiosk.latitude }}, {{ kiosk.longitude }}],
        [{{ kiosk.reported_latitude }}, {{ kiosk.reported_longitude }}]
    ];
    const polyline = L.polyline(latlngs, {color: 'red'}).addTo(kioskMap);

    // Ajustar vista para mostrar ambos puntos
    const bounds = L.latLngBounds([
        [{{ kiosk.latitude }}, {{ kiosk.longitude }}],
        [{{ kiosk.reported_latitude }}, {{ kiosk.reported_longitude }}]
    ]);
    kioskMap.fitBounds(bounds);
    {% endif %}
}

function centerMap() {
    if (kioskMap) {
        kioskMap.setView([{{ kiosk.latitude }}, {{ kiosk.longitude }}], 13);
    }
}
{% endif %}

function loadLocationHistory() {
    fetch('/kiosk/api/kiosk/{{ kiosk.id }}/location_history')
        .then(function(response) {
            return response.json();
        })
        .then(function(history) {
            const tbody = document.getElementById('location-history-table');
            if (!history || history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay historial de ubicaciones disponible</td></tr>';
                return;
            }

            let html = '';
            for (let h of history) {
                html += '<tr>';
                html += '<td>' + new Date(h.timestamp).toLocaleString() + '</td>';
                html += '<td><span class="badge bg-' + (h.location_type === 'assigned' ? 'primary' : 'info') + '">';
                html += h.location_type === 'assigned' ? 'Asignada' : 'Reportada';
                html += '</span></td>';
                html += '<td>';
                if (h.previous_latitude && h.previous_longitude) {
                    html += h.previous_latitude.toFixed(6) + ', ' + h.previous_longitude.toFixed(6);
                } else {
                    html += 'N/A';
                }
                html += '</td>';
                html += '<td>' + h.latitude.toFixed(6) + ', ' + h.longitude.toFixed(6) + '</td>';
                html += '<td>' + (h.accuracy ? h.accuracy.toFixed(2) + 'm' : 'N/A') + '</td>';
                html += '<td>' + (h.change_reason || 'N/A') + '</td>';
                html += '</tr>';
            }
            tbody.innerHTML = html;
        })
        .catch(function(error) {
            console.error('Error cargando historial:', error);
            document.getElementById('location-history-table').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">Error al cargar el historial</td></tr>';
        });
}

function refreshLocationHistory() {
    const tbody = document.getElementById('location-history-table');
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">' +
        '<div class="spinner-border spinner-border-sm" role="status">' +
        '<span class="visually-hidden">Cargando...</span></div> Actualizando...</td></tr>';
    loadLocationHistory();
}

document.addEventListener('DOMContentLoaded', function() {
    initMap();
    loadLocationHistory();
});

// Datos para el gráfico
const sensorData = {
    timestamps: [{% for data in recent_data %}"{{ data.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}"{{ "," if not loop.last }}{% endfor %}],
    cpu: [{% for data in recent_data %}{{ data.cpu_usage }}{{ "," if not loop.last }}{% endfor %}],
    memory: [{% for data in recent_data %}{{ data.memory_usage }}{{ "," if not loop.last }}{% endfor %}],
    network: [{% for data in recent_data %}{{ data.network_latency or 0 }}{{ "," if not loop.last }}{% endfor %}]
};

// Configuración del gráfico
const ctx = document.getElementById('sensorChart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: sensorData.timestamps,
        datasets: [{
            label: 'CPU (%)',
            data: sensorData.cpu,
            borderColor: 'rgb(255, 99, 132)',
            tension: 0.1
        }, {
            label: 'Memoria (%)',
            data: sensorData.memory,
            borderColor: 'rgb(54, 162, 235)',
            tension: 0.1
        }, {
            label: 'Latencia (ms)',
            data: sensorData.network,
            borderColor: 'rgb(75, 192, 192)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Función para actualizar el gráfico
function updateChart() {
    fetch(`/kiosk/api/sensor-data/${kiosk.id}`)
        .then(response => response.json())
        .then(data => {
            chart.data.labels = data.timestamps;
            chart.data.datasets[0].data = data.cpu;
            chart.data.datasets[1].data = data.memory;
            chart.data.datasets[2].data = data.network;
            chart.update();
        });
}

// Actualizar cada 30 segundos
setInterval(updateChart, 30000);

// Función para mostrar estado de conexión
function showConnectionStatus(connected) {
    const statusDiv = document.getElementById('connection-status');
    if (connected) {
        statusDiv.innerHTML = '<span class="badge bg-success">Conectado</span>';
    } else {
        statusDiv.innerHTML = '<span class="badge bg-danger">Desconectado</span>';
    }
}

// Función para actualizar métricas en tiempo real
function updateMetrics(data) {
    // Actualizar indicadores de salud
    document.getElementById('health-score').style.width = `${data.health_score}%`;
    document.getElementById('health-score').textContent = `${data.health_score.toFixed(1)}%`;
    
    // Actualizar probabilidad de anomalía
    document.getElementById('anomaly-prob').textContent = 
        `${(data.anomaly_probability * 100).toFixed(2)}%`;
        
    // Actualizar gráfico si existe
    if (sensorChart) {
        const timestamp = new Date(data.timestamp).toLocaleTimeString();
        
        sensorChart.data.labels.push(timestamp);
        sensorChart.data.datasets[0].data.push(data.cpu_usage);
        sensorChart.data.datasets[1].data.push(data.memory_usage);
        sensorChart.data.datasets[2].data.push(data.network_latency);
        
        // Mantener solo los últimos 20 puntos
        if (sensorChart.data.labels.length > 20) {
            sensorChart.data.labels.shift();
            sensorChart.data.datasets.forEach(dataset => dataset.data.shift());
        }
        
        sensorChart.update();
    }
}

// Función para mostrar alertas
function showAlert(data) {
    const alertsContainer = document.getElementById('alerts-container');
    const alert = document.createElement('div');
    alert.className = 'alert alert-warning alert-dismissible fade show';
    alert.innerHTML = `
        <strong>${data.timestamp}</strong>: ${data.message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertsContainer.prepend(alert);
    
    // Eliminar alertas antiguas si hay más de 5
    const alerts = alertsContainer.getElementsByClassName('alert');
    if (alerts.length > 5) {
        alertsContainer.removeChild(alerts[alerts.length - 1]);
    }
}

// Función para mostrar anomalías
function showAnomaly(data) {
    const anomalyContainer = document.getElementById('anomaly-container');
    const anomaly = document.createElement('div');
    anomaly.className = 'alert alert-danger mb-2';
    anomaly.innerHTML = `
        <h5 class="alert-heading">¡Anomalía Detectada!</h5>
        <p>Probabilidad: ${(data.probability * 100).toFixed(2)}%</p>
        <hr>
        <p class="mb-0">Métricas Anómalas:</p>
        <ul>
            ${Object.entries(data.metrics).map(([key, value]) => 
                `<li>${key}: ${value}</li>`
            ).join('')}
        </ul>
    `;
    anomalyContainer.prepend(anomaly);
    
    // Eliminar anomalías antiguas si hay más de 3
    const anomalies = anomalyContainer.getElementsByClassName('alert');
    if (anomalies.length > 3) {
        anomalyContainer.removeChild(anomalies[anomalies.length - 1]);
    }
}
</script>
{% endblock %} 